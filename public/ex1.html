<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exp 01: Water Jug Problem | SRM LabOS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CSS STYLES --- */
        :root {
            /* Palette: Deep Space */
            --bg-app: #030712; 
            --bg-panel: #0b0f19; /* Updated to match new sidebar */
            --bg-card: rgba(31, 41, 55, 0.4);
            
            --border-subtle: rgba(255, 255, 255, 0.06);
            --border-highlight: rgba(255, 255, 255, 0.1);

            --primary: #6366f1; 
            --primary-glow: rgba(99, 102, 241, 0.4);
            
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;

            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --text-dim: #6b7280;

            --font-main: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --radius-lg: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05), transparent 25%);
        }

        /* --- PROFESSIONAL EXPANDING SIDEBAR (COPIED FROM UPPER CODE) --- */
        aside {
            width: 80px; /* Default Collapsed Width */
            height: 100vh;
            background: var(--bg-panel);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            padding: 24px 12px;
            z-index: 50;
            flex-shrink: 0;
            transition: width 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
        }

        /* Expand on Hover */
        aside:hover {
            width: 260px;
            padding: 24px 16px;
        }

        /* Header */
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 32px;
            padding-left: 4px;
            height: 40px;
            overflow: hidden;
        }

        .brand-logo {
            min-width: 36px; height: 36px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 8px;
            display: grid; place-items: center;
            font-weight: 800; font-size: 1.2rem;
            color: white;
            box-shadow: 0 0 15px var(--primary-glow);
        }

        .brand-text {
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: white;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        /* Nav Labels & Items */
        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            font-weight: 600;
            margin: 20px 0 8px 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s;
            height: 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 12px;
            border-radius: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-item i {
            min-width: 20px;
            text-align: center;
            font-size: 1.1rem;
            transition: color 0.2s;
        }

        .nav-item span {
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }

        /* Hover States */
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        
        .nav-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: white;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .nav-item.active i { color: var(--primary); }

        /* Expand Logic */
        aside:hover .brand-text,
        aside:hover .nav-item span,
        aside:hover .user-info,
        aside:hover .arrow-icon {
            opacity: 1;
            transition-delay: 0.1s;
        }
        aside:hover .nav-label {
            opacity: 1;
            height: auto;
            margin: 20px 0 8px 12px;
        }

        /* Footer / User Profile */
        .sidebar-footer {
            margin-top: auto;
            border-top: 1px solid var(--border-subtle);
            padding-top: 16px;
            overflow: hidden;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            white-space: nowrap;
        }
        .user-profile:hover { background: rgba(255,255,255,0.05); }

        .profile-pic {
            min-width: 32px; height: 32px;
            border-radius: 50%;
            background: #374151;
            display: grid; place-items: center;
            font-size: 0.8rem; font-weight: 600; color: white;
        }

        .user-info { flex: 1; opacity: 0; transition: opacity 0.2s; }
        .user-name { font-size: 0.85rem; font-weight: 600; color: white; }
        .user-role { font-size: 0.75rem; color: var(--text-dim); }
        .arrow-icon { opacity: 0; transition: opacity 0.2s; }

        /* --- MAIN AREA --- */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* Header */
        header {
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 40px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .breadcrumbs { font-size: 0.9rem; color: var(--text-muted); }
        .breadcrumbs span { color: white; font-weight: 500; }
        .breadcrumbs i { font-size: 0.75rem; margin: 0 10px; color: var(--text-dim); }

        /* Content Grid */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        .page-header { display: flex; justify-content: space-between; align-items: flex-end; }
        h1 { font-size: 2rem; font-weight: 700; letter-spacing: -1px; margin-bottom: 4px; color: white; }
        .subtitle { color: var(--text-muted); font-size: 0.95rem; display: flex; align-items: center; gap: 8px; }

        /* KPI Cards */
        .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; }

        .kpi-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            display: flex; flex-direction: column; justify-content: space-between;
            height: 140px; transition: transform 0.2s, border-color 0.2s;
        }
        .kpi-card:hover { transform: translateY(-2px); border-color: var(--border-highlight); }
        
        .kpi-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .kpi-value { font-size: 2.5rem; font-weight: 700; color: white; margin-top: 8px; letter-spacing: -1px; }
        .kpi-trend { font-size: 0.8rem; margin-top: auto; display: flex; gap: 6px; align-items: center; }

        /* Data Panel & Table */
        .data-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            display: flex; flex-direction: column;
            overflow: hidden; flex: 1; min-height: 500px;
        }

        .toolbar { padding: 20px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; }

        .search-box { position: relative; width: 320px; }
        .search-box i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--text-dim); }
        .search-box input {
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 16px 12px 42px;
            color: white; width: 100%; font-size: 0.9rem; transition: 0.2s;
        }
        .search-box input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        /* Table Styling */
        .table-container { flex: 1; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        
        th {
            text-align: left; padding: 16px 24px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600;
            border-bottom: 1px solid var(--border-subtle); background: rgba(0,0,0,0.2); position: sticky; top: 0; backdrop-filter: blur(10px);
        }
        td { padding: 18px 24px; border-bottom: 1px solid var(--border-subtle); font-size: 0.9rem; color: var(--text-dim); vertical-align: middle; }
        tr:hover td { background: rgba(255,255,255,0.02); color: white; }

        .user-cell { display: flex; align-items: center; gap: 12px; color: white; font-weight: 500; }
        .avatar { width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(to right, #4f46e5, #ec4899); display: grid; place-items: center; font-size: 0.7rem; font-weight: 700; color: white; }
        .mono-text { font-family: var(--font-mono); color: var(--text-muted); font-size: 0.85rem; }

        .btn { padding: 8px 16px; font-size: 0.85rem; font-weight: 600; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle); color: var(--text-main); }
        .btn-secondary:hover { background: rgba(255,255,255,0.1); }
        .btn-primary { background: var(--primary); color: white; border: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
        
        .action-btn { background: transparent; border: 1px solid var(--border-subtle); color: var(--text-muted); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn:hover { color: white; border-color: var(--text-muted); }

        .status-pill { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        .pill-success { background: rgba(16, 185, 129, 0.15); color: #34d399; }
        .pill-danger { background: rgba(239, 68, 68, 0.15); color: #f87171; }

        .risk-badge { font-size: 0.8rem; font-weight: 600; }
        .risk-high { color: var(--danger); }
        .risk-med { color: var(--warning); padding: 2px 6px; background: rgba(245, 158, 11, 0.1); border-radius: 4px; }
        .risk-low { color: var(--text-muted); }

        .integrity-box { display: flex; gap: 12px; font-size: 0.85rem; font-family: var(--font-mono); }
        .integrity-item { display: flex; align-items: center; gap: 6px; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    </style>
</head>
<body>

    <aside>
        <div class="sidebar-header">
            <div class="brand-logo">L</div>
            <div class="brand-text">SRM LabOS</div>
        </div>

        <div class="nav-label">GENERAL</div>
        <a href="admin.html" class="nav-item">
            <i class="fa-solid fa-chart-pie"></i> <span>Dashboard</span>
        </a>
        <a href="#" class="nav-item active">
            <i class="fa-solid fa-flask"></i> <span>Inbox</span>
        </a>

        <div class="nav-label">ACADEMICS</div>
        <a href="submit.html" class="nav-item">
            <i class="fa-solid fa-users"></i> <span>Experiments</span>
        </a>
        <a href="#" class="nav-item">
            <i class="fa-solid fa-shield-halved"></i> <span>Students</span>
        </a>

        <div class="nav-label">SYSTEM</div>
        <a href="#" class="nav-item">
            <i class="fa-solid fa-gear"></i> <span>Resources</span>
        </a>
        <div class="nav-item" style="cursor: pointer;">
            <i class="fa-solid fa-arrow-right-from-bracket" style="color: var(--danger);"></i> <span>Settings</span>
        </div>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="profile-pic">HP</div>
                <div class="user-info">
                    <div class="user-name">Dr.Hariprasad S</div>
                    <div class="user-role">FACULTY</div>
                </div>
                <i class="fa-solid fa-arrow-right-from-bracket arrow-icon" style="color: var(--text-dim);"></i>
            </div>
        </div>
    </aside>

    <main>
        <header>
            <div class="breadcrumbs">
                Academics <i class="fa-solid fa-chevron-right"></i> 21AIC202J <i class="fa-solid fa-chevron-right"></i> <span>Exp 01: Water Jug Problem</span>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
                <div style="font-size: 0.8rem; color: var(--success); font-weight: 700; background: rgba(16, 185, 129, 0.1); padding: 6px 12px; border-radius: 99px; border: 1px solid rgba(16, 185, 129, 0.2); text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fa-solid fa-circle" style="font-size: 6px; margin-right: 6px; vertical-align: middle;"></i> System Operational
                </div>
            </div>
        </header>

        <div class="content">
            
            <div class="page-header">
                <div>
                    <h1>Submission Intelligence</h1>
                    <div class="subtitle">Real-time monitoring and integrity analysis for Experiment 01.</div>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="loadData()"><i class="fa-solid fa-rotate-right"></i> Refresh</button>
                    <button class="btn btn-primary" onclick="alert('Feature coming soon')"><i class="fa-solid fa-download"></i> Export Report</button>
                </div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-label">Total Submissions</div>
                    <div class="kpi-value" id="stat-total">--</div>
                    <div class="kpi-trend" style="color: var(--text-dim);">Live records</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Completion Rate</div>
                    <div class="kpi-value" id="stat-rate">--%</div>
                    <div class="kpi-trend" style="color: var(--success);">
                        <i class="fa-solid fa-arrow-trend-up"></i> Successful runs
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-label">Avg Duration</div>
                    <div class="kpi-value" id="stat-time">--:--</div>
                    <div class="kpi-trend" style="color: var(--primary);">Mean time to solve</div>
                </div>
                <div class="kpi-card" style="border-color: rgba(239,68,68,0.3);">
                    <div class="kpi-label" style="color: var(--danger);">Critical Violations</div>
                    <div class="kpi-value" id="stat-flag" style="color: var(--danger);">--</div>
                    <div class="kpi-trend" style="color: var(--danger);">Terminated sessions</div>
                </div>
            </div>

            <div class="data-panel">
                <div class="toolbar">
                    <div class="search-box">
                        <i class="fa-solid fa-magnifying-glass"></i>
                        <input type="text" id="searchInput" placeholder="Search by Student or Reg No..." onkeyup="filterTable()">
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 0.85rem; color: var(--text-muted); font-weight: 500;">
                        <span style="cursor:pointer;"><i class="fa-solid fa-filter" style="margin-right:6px;"></i> Filters: All</span>
                        <span style="cursor:pointer;"><i class="fa-solid fa-arrow-down-short-wide" style="margin-right:6px;"></i> Sort: Date</span>
                    </div>
                </div>
                
                <div class="table-container">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Reg Number</th>
                                <th>Duration</th>
                                <th>Risk Analysis</th>
                                <th>Integrity</th>
                                <th>Status</th>
                                <th>Timestamp</th>
                                <th style="text-align: right;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- CONFIGURATION ---
        const API_BASE = 'https://nural-network-ml.onrender.com/api'; 
        let allLogs = [];

        // --- FETCH DATA ---
        async function loadData() {
            const btn = document.querySelector('.fa-rotate-right');
            btn.classList.add('fa-spin');

            try {
                const statsRes = await fetch(`${API_BASE}/admin/stats`);
                if(!statsRes.ok) throw new Error('Stats fetch failed');
                const statsData = await statsRes.json();

                const logsRes = await fetch(`${API_BASE}/admin/logs`);
                if(!logsRes.ok) throw new Error('Logs fetch failed');
                const logsData = await logsRes.json();

                allLogs = logsData;
                updateDashboard(statsData, logsData);

            } catch (error) {
                console.error("Connection Error:", error);
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--danger); padding:20px;">
                    <i class="fa-solid fa-triangle-exclamation"></i> Connection Failed.<br>
                    <span style="font-size:0.8rem; color:var(--text-muted);">Could not fetch data from ${API_BASE}</span>
                </td></tr>`;
            } finally {
                btn.classList.remove('fa-spin');
            }
        }

        // --- UPDATE UI ---
        function updateDashboard(stats, logs) {
            document.getElementById('stat-total').innerText = stats.total;
            document.getElementById('stat-flag').innerText = stats.terminated;
            
            const rate = stats.total > 0 ? Math.round((stats.completed / stats.total) * 100) : 0;
            document.getElementById('stat-rate').innerText = rate + '%';

            const avgTime = calculateAvgTime(logs);
            document.getElementById('stat-time').innerText = avgTime;

            renderTable(logs);
        }

        // --- RENDER TABLE ---
        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="8" style="text-align:center; color:var(--text-muted); padding:30px;">No records found in database.</td></tr>`;
                return;
            }

            data.forEach(log => {
                const initials = log.studentName ? log.studentName.split(' ').map(n=>n[0]).join('').substring(0,2).toUpperCase() : '??';
                
                const violations = (log.tabSwitches || 0) + (log.screenShots || 0);
                let riskBadge = `<span class="risk-badge risk-low">Low</span>`;
                if(log.status === 'TERMINATED' || violations >= 3) riskBadge = `<span class="risk-badge risk-high">Critical</span>`;
                else if(violations > 0) riskBadge = `<span class="risk-badge risk-med">Moderate</span>`;

                const statusBadge = log.status === 'COMPLETED' 
                    ? `<span class="status-pill pill-success">Completed</span>` 
                    : `<span class="status-pill pill-danger">Terminated</span>`;

                const dateObj = new Date(log.submittedAt);
                const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <div class="user-cell">
                            <div class="avatar">${initials}</div>
                            <div style="font-weight: 500;">${log.studentName}</div>
                        </div>
                    </td>
                    <td class="mono-text">${log.regNo}</td>
                    <td style="color: white;">${log.timeTaken}</td>
                    <td>${riskBadge}</td>
                    <td>
                        <div class="integrity-box">
                            <div class="integrity-item" style="color: ${log.tabSwitches > 0 ? '#fbbf24' : 'inherit'}">
                                <i class="fa-regular fa-window-maximize"></i> ${log.tabSwitches}
                            </div>
                            <div class="integrity-item" style="color: ${log.screenShots > 0 ? '#f87171' : 'inherit'}">
                                <i class="fa-solid fa-camera"></i> ${log.screenShots}
                            </div>
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td class="mono-text" style="font-size:0.8rem">${dateStr}</td>
                    <td style="text-align: right;">
                        <button class="action-btn" onclick="deleteLog(${log.id})">
                            <i class="fa-regular fa-trash-can"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ACTIONS ---
        async function deleteLog(id) {
            if(!confirm('Are you sure you want to permanently delete this record?')) return;

            try {
                const res = await fetch(`${API_BASE}/admin/logs/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    loadData();
                } else {
                    alert('Failed to delete log.');
                }
            } catch (e) {
                console.error(e);
                alert('Error deleting log.');
            }
        }

        function filterTable() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allLogs.filter(l => 
                l.studentName.toLowerCase().includes(term) || 
                l.regNo.toLowerCase().includes(term)
            );
            renderTable(filtered);
        }

        function calculateAvgTime(logs) {
            if(!logs.length) return "00:00";
            let totalSeconds = 0;
            let count = 0;

            logs.forEach(l => {
                if(l.timeTaken && l.timeTaken.includes(':')) {
                    const [m, s] = l.timeTaken.split(':').map(Number);
                    totalSeconds += (m * 60) + s;
                    count++;
                }
            });

            if(count === 0) return "00:00";
            const avgSec = Math.round(totalSeconds / count);
            const m = Math.floor(avgSec / 60).toString().padStart(2, '0');
            const s = (avgSec % 60).toString().padStart(2, '0');
            return `${m}:${s}`;
        }

        loadData();
        setInterval(loadData, 10000);

    </script>
</body>
</html>